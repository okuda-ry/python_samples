<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Color Game</title>
        <style>
            .box {
      width: 150px;
      height: 150px;
      border: 1px solid #000;
      margin: 10px;
    }
        </style>
    </head>

    <body>

{{ target|json_script:"target-data" }}

<h2>ğŸ¯ ãŠé¡Œã®è‰²</h2>
<div id="targetBox" class="box"></div>

<h2>ğŸš° è›‡å£</h2>
èµ¤ <input type="range" id="red" min="0" max="100"> <span id="redVal">0</span><br>
ç·‘ <input type="range" id="green" min="0" max="100"> <span id="greenVal">0</span><br>
é’ <input type="range" id="blue" min="0" max="100"> <span id="blueVal">0</span><br>

<h2>ğŸ’§ åˆæˆçµæœ</h2>
<div id="result" class="box"></div>

<button onclick="judge()">åˆ¤å®š</button>
<p id="message"></p>

<script>
const targetColor = JSON.parse(document.getElementById("target-data").textContent);
document.getElementById("targetBox").style.backgroundColor =
  `rgb(${targetColor.r},${targetColor.g},${targetColor.b})`;

function mixColor() {
  const r = document.getElementById("red").value;
  const g = document.getElementById("green").value;
  const b = document.getElementById("blue").value;

  const total = Number(r) + Number(g) + Number(b);
  if (total === 0) return [0,0,0];

  const rr = Math.floor(255 * Number(r) / total);
  const gg = Math.floor(255 * Number(g) / total);
  const bb = Math.floor(255 * Number(b) / total);

  return [rr, gg, bb];
}

function update() {
  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤è¡¨ç¤ºã‚’æ›´æ–°
  document.getElementById("redVal").textContent = document.getElementById("red").value;
  document.getElementById("greenVal").textContent = document.getElementById("green").value;
  document.getElementById("blueVal").textContent = document.getElementById("blue").value;

  const [r,g,b] = mixColor();
  document.getElementById("result").style.backgroundColor =
    `rgb(${r},${g},${b})`;
}

document.querySelectorAll("input[type=range]")
  .forEach(s => s.oninput = update);

// åˆæœŸè¡¨ç¤ºã‚’æ›´æ–°
update();

function judge() {
  const [r,g,b] = mixColor();

  // ã‚µãƒ¼ãƒã«ãŠé¡Œã®å‰²åˆã‚’æ¸¡ã—ã¦ã‚µãƒ¼ãƒå´ã§åŒã˜åˆæˆã‚’è¡Œã‚ã›ã€å¿œç­”ã«ã‚‚å‰²åˆã‚’å«ã‚ã‚‹
  fetch(`/judge/?r=${r}&g=${g}&b=${b}&pr=${targetColor.p_r}&pg=${targetColor.p_g}&pb=${targetColor.p_b}`)
    .then(res => res.json())
    .then(data => {
      const msgEl = document.getElementById("message");
      // ç­”ãˆè¡¨ç¤ºã¯å‰²åˆã®ã¿ï¼ˆRGBè¡¨ç¤ºã¯ã—ãªã„ï¼‰
      const percent = data.target_percent
        ? `å‰²åˆ: ${data.target_percent.p_r}% ${data.target_percent.p_g}% ${data.target_percent.p_b}%`
        : `å‰²åˆ: ${targetColor.p_r}% ${targetColor.p_g}% ${targetColor.p_b}%`;
      const rankText = `${data.rank}ãƒ©ãƒ³ã‚¯ â€” å·®: ${data.diff}`;
      msgEl.innerHTML = (data.clear ? `ğŸ‰ ${rankText}` : rankText) + `<br>` + percent;
    });
}
</script>
</body>
</html>
